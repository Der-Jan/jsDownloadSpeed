<html>
<head>
<title>Jans Download Test</title>
<script type="text/javascript" src="canvasjs.min.js"></script>
<script>
	var startTime = 0;
	var imgSize = 2990713;
	var maxConc = 0;
	var maxConcCheck = 10;
	var currentlyLoading = 0;
	var minMillis = 8000;
	var loadedImages=0;
	var inProgressImages=0;
	var maxLoad=84;
	var bytesPerImage = [];
	var smallInProgress = [];
	var dps = [{x: 0, y: 0}];
	var chart;
	
	function setupChart() {
		chart = new CanvasJS.Chart("chartContainer",{
			title :{
				text: "Downloadrate"
			},
			axisX: {						
				title: "time in s",
				minimum: 0,
				maximum: 10
			},
			axisY: {						
				title: "MBit/s"
			},
			data: [{
				type: "line",
				dataPoints : dps
			}]
			});
		chart.render();
		setInterval(function() {chart.render();}, 100);
	}
	function updateSpeed(curTime) {
		document.getElementById("result").innerHTML += " Took " + ( curTime - startTime )/1000 + "s for " + Math.round(10*imgSize*loadedImages/1024/1024)/10 + "MB - rate is " + Math.round(80000*imgSize*loadedImages/1024/1024/( curTime - startTime ))/10 + "MBit/s<br/>" ;
	}
        function addImg(){
		while ((currentlyLoading<maxConc) && (loadedImages + currentlyLoading < maxLoad)) {
		currentlyLoading++;
		inProgressImages++;
		img = new XMLHttpRequest();
		img.imgID=inProgressImages;
		img.addEventListener("load", function(e) {
			if (this.status == 200) {
				currentlyLoading--;
				loadedImages++;
				curTime = Date.now();	
				this.blob = null;
				document.getElementById("progress").innerHTML += this.imgID + ".";
				if ( curTime - startTime < minMillis){
					addImg();	
				} else {
					if (currentlyLoading == 0) {
						document.getElementById("progress").innerHTML += "Done!";
						updateSpeed(curTime);
					}
				}
			}
		}, true);
		img.addEventListener("progress", function(e) {
			curTime = Date.now();
			bytesPerImage[this.imgID] = e.loaded;
			currentData = 0;
			for (i in bytesPerImage) currentData += bytesPerImage[i];
			document.getElementById("curspeed").innerHTML = (8000*currentData/1024/1024/( curTime - startTime )).toFixed(2) + "MBit/s" ;
			dps.push({x: ( curTime - startTime )/1000, y: 8000*currentData/1024/1024/( curTime - startTime )});
			
		});
		img.addEventListener("error", function(e) {
		//	document.getElementById("result").innerHTML += "Error: " + e;
		});
		img.open("GET", "passbild.jpg?"+loadedImages+Math.random(), true);
		img.responseType = "blob";
		img.send();
		if (startTime == 0) startTime=Date.now();
		}
	};
	function addSmallImg() {
		setupChart();
		for (currentlyLoading = 0; currentlyLoading < 10; currentlyLoading++) {
			img = new XMLHttpRequest();
			img.imgID = currentlyLoading;
			img.addEventListener("load", function(e) {
				if (this.status == 200) {
					currentlyLoading--;
					active = 0;
					for (i in smallInProgress) active +=smallInProgress[i];
					if (active>maxConc) {
						maxConc = active;
						document.getElementById("result").innerHTML += "Concurrent max " + maxConc + " connections<br/>";
					}
					smallInProgress[this.imgID]=0;
					this.blob = null;
					document.getElementById("progress").innerHTML += "+";
					if (currentlyLoading == 0) addImg();	
				}
			}, true);
			img.onprogress = function(e) {
				smallInProgress[this.imgID]=1;		
			}
			img.open("GET", "small.jpg?"+loadedImages+Math.random(), true);
			img.responseType = "blob";
			img.send();
		}
	};
</script>
</head>
<body onload="addSmallImg()">
<h1>Jans Download Test</h1>
<div id='progress'>
</div>
<div id='curspeed'>
0.00 MBit/s
</div>
<div id='result'>
</div>
<div id="chartContainer" style="height: 300px; width: 600px;">
</div>
</body>
</html>
